// Generated by CoffeeScript 1.7.1
var BasicOptions, EditCore, Fragment, Headline, OrgEditing, Results, SimpleMarkup, Source, blockAttrs, blockLabel, contentSpan, escapeAttr, escapeHtml, last, orgDoc, parseOrgMode, _ref, _ref1,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

_ref = window.Org, parseOrgMode = _ref.parseOrgMode, orgDoc = _ref.orgDoc, Source = _ref.Source, Results = _ref.Results, Headline = _ref.Headline, SimpleMarkup = _ref.SimpleMarkup, Fragment = _ref.Fragment;

_ref1 = EditCore = window.EditCore, last = _ref1.last, BasicOptions = _ref1.BasicOptions;

OrgEditing = (function(_super) {
  __extends(OrgEditing, _super);

  function OrgEditing() {
    OrgEditing.__super__.constructor.call(this);
    this.rerender = {};
  }

  OrgEditing.prototype.moved = function(editor) {
    var blockId, cur, curBlock, lines, offset, text, _ref2, _results;
    _ref2 = editor.getBlockLocation(), blockId = _ref2.blockId, offset = _ref2.offset;
    if (blockId) {
      text = this.blocks[blockId].text.substring(0, offset);
      lines = text.split('\n');
      $("#status").html("Block: " + blockId + ", line: " + lines.length + ", col: " + (last(lines).length));
    }
    return;
    cur = this.first;
    lines = 0;
    _results = [];
    while (cur && (curBlock = this.blocks[cur])) {
      if (cur._id === block._id) {
        $("#status").html("Line: " + pos.line + ", col: " + pos.column);
        break;
      }
      _results.push(cur = curBlock.next);
    }
    return _results;
  };

  OrgEditing.prototype.parseBlocks = function(text) {
    return orgDoc(parseOrgMode(text.replace(/\r\n/g, '\n')));
  };

  OrgEditing.prototype.newBlocks = function(blocks) {
    OrgEditing.__super__.newBlocks.call(this, blocks);
    this.findParents();
    return this.findChildren();
  };

  OrgEditing.prototype.isMergeable = function(newBlock, neighbor, oldBlock) {
    return newBlock.type === 'chunk' && oldBlock.type !== 'chunk' && (neighbor != null ? neighbor.type : void 0) === 'chunk';
  };

  OrgEditing.prototype.edit = function(func) {
    var block, id, newFirst, p, _ref2, _ref3;
    _ref2 = this.changes = func(), this.removes = _ref2.removes, this.updates = _ref2.updates;
    newFirst = this.blocks[this.first];
    while (this.removes[newFirst._id]) {
      newFirst = newFirst.next && this.blocks[newFirst.next];
    }
    if (newFirst) {
      while (p = newFirst.prev) {
        newFirst = this.getChangedBlock(p);
      }
    }
    for (id in this.removes) {
      $("#" + id).remove();
    }
    this.oldParents = this.parents;
    this.changes.applyChanges();
    this.findParents();
    this.findChildren();
    _ref3 = this.updates;
    for (id in _ref3) {
      block = _ref3[id];
      this.setUpdateRerender(block);
    }
    for (id in this.rerender) {
      this.rerenderBlock(this.blocks[id]);
    }
    this.updates = null;
    this.removes = null;
    this.rerender = {};
    return this.newParents = null;
  };

  OrgEditing.prototype.setRemoveRerender = function(id) {
    while (this.removes[id]) {
      id = this.parents[id];
    }
    if (id) {
      return this.rerender[id] = true;
    }
  };

  OrgEditing.prototype.setUpdateRerender = function(newBlock) {
    var np, oldBlock, op;
    oldBlock = this.getOldBlock(newBlock._id);
    if (!oldBlock) {
      return this.rerender[newBlock._id] = true;
    } else {
      np = this.parents[newBlock._id];
      op = this.oldParents[oldBlock._id];
      if (np === op) {
        return this.rerender[newBlock._id] = true;
      } else {
        $("#" + newBlock._id).remove();
        if (np) {
          this.rerender[np] = true;
        } else {
          this.rerender[newBlock._id] = true;
        }
        if (op) {
          return this.rerender[op] = true;
        }
      }
    }
  };

  OrgEditing.prototype.getChangedBlock = function(id) {
    return this.changes.getChangedBlock(id);
  };

  OrgEditing.prototype.getOldBlock = function(id) {
    return this.changes.getOldBlock(id);
  };

  OrgEditing.prototype.findParents = function() {
    var parents;
    parents = this.parents = {};
    return this.findStructure(this.first, function(parent, child) {
      return parents[child._id] = parent != null ? parent._id : void 0;
    });
  };

  OrgEditing.prototype.findChildren = function() {
    var children;
    children = this.children = {};
    return this.findStructure(this.first, (function(_this) {
      return function(parent, child) {
        var childList, parentId, prev, _ref2;
        parentId = parent ? parent._id : 'TOP';
        childList = (_ref2 = children[parentId]) != null ? _ref2 : (children[parentId] = []);
        prev = _this.getBlock(last(childList));
        childList.push(child._id);
        if (prev) {
          child.previousSibling = prev._id;
          return prev.nextSibling = child._id;
        }
      };
    })(this));
  };

  OrgEditing.prototype.findStructure = function(blockId, func, all) {
    var ancestors, block, original, parent, _results;
    original = this.blocks[blockId];
    if (original.type === 'headline') {
      ancestors = [];
      _results = [];
      while (blockId && (block = this.blocks[blockId])) {
        parent = last(ancestors);
        if (block.type === 'headline') {
          if (!parent || block.level > parent.level) {
            ancestors.push(block);
          } else {
            while (block.level <= parent.level) {
              ancestors.pop();
              parent = last(ancestors);
            }
            ancestors.push(block);
          }
          parent = ancestors.length > 1 ? ancestors[ancestors.length - 2] : void 0;
        }
        func(parent, block);
        _results.push(blockId = block.next);
      }
      return _results;
    } else {
      return func(null, original);
    }
  };

  OrgEditing.prototype.rerenderBlock = function(block) {
    var html, next, node, prev;
    if (block) {
      html = this.renderBlock(block)[0];
      if ((node = $("#" + block._id)).length) {
        return node.replaceWith(html);
      } else if (block.nextSibling && (next = $("#" + block.nextSibling)).length) {
        return next.before(html);
      } else if (block.previousSibling && (prev = $("#" + block.previousSibling)).length) {
        return prev.after(html);
      } else {
        return $(this.editor.node).append(html);
      }
    }
  };

  OrgEditing.prototype.renderBlock = function(block) {
    var childId, html;
    html = block.type === 'headline' ? "<div " + (blockAttrs(block)) + ">" + (blockLabel(block)) + (contentSpan(block.text, 'text')) + (((function() {
      var _i, _len, _ref2, _ref3, _results;
      _ref3 = (_ref2 = this.children[block._id]) != null ? _ref2 : [];
      _results = [];
      for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
        childId = _ref3[_i];
        _results.push(this.renderBlock(this.blocks[childId])[0]);
      }
      return _results;
    }).call(this)).join('')) + "</div>" : "<span " + (blockAttrs(block)) + ">" + (blockLabel(block)) + (escapeHtml(block.text)) + "</span>";
    return [html, block.nextSibling];
  };

  return OrgEditing;

})(BasicOptions);

blockLabel = function(block) {
  return "<span class='blockLabel' contenteditable='false' data-noncontent>[" + block.type + "]</span>";
};

blockAttrs = function(block) {
  var extra;
  extra = '';
  if (block.type === 'headline') {
    extra += " data-headline='" + (escapeAttr(block.level)) + "'";
  }
  return "id='" + (escapeAttr(block._id)) + "' data-type='" + (escapeAttr(block.type)) + "'" + extra;
};

contentSpan = function(str, type) {
  str = escapeHtml(str);
  if (str) {
    return "<span" + (type ? " data-org-type='" + (escapeAttr(type)) + "'" : '') + ">" + str + "</span>";
  } else {
    return '';
  }
};

escapeHtml = function(str) {
  if (typeof str === 'string') {
    return str.replace(/[<>&]/g, function(c) {
      return replacements[c];
    });
  } else {
    return str;
  }
};

escapeAttr = function(str) {
  if (typeof str === 'string') {
    return str.replace(/['"&]/g, function(c) {
      switch (c) {
        case '"':
          return '&quot;';
        case "'":
          return '&#39;';
        case '&':
          return '&amp;';
      }
    });
  } else {
    return str;
  }
};

$(document).ready(function() {
  var editor;
  editor = new EditCore($("#editor"), new OrgEditing());
  editor.loadURL("example.lorg");
  return window.ED = editor;
});

//# sourceMappingURL=example.map
