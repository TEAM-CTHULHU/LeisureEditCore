// Generated by CoffeeScript 1.9.1
(function() {
  var DataStore, DataStoreEditingOptions, FancyEditing, Fragment, Headline, LeisureEditCore, MFSet, OrgData, OrgEditing, PlainEditing, Results, SimpleMarkup, Source, blockAttrs, blockLabel, blockText, checkStructure, contentSpan, copy, data, displayStructure, escapeAttr, escapeHtml, getId, last, linkAllSiblings, numSpan, orgDoc, orgEditing, parent, parseOrgMode, plainEditing, posFor, ref, ref1, siblings,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  ref = window.Org, parseOrgMode = ref.parseOrgMode, orgDoc = ref.orgDoc, Source = ref.Source, Results = ref.Results, Headline = ref.Headline, SimpleMarkup = ref.SimpleMarkup, Fragment = ref.Fragment;

  ref1 = LeisureEditCore = window.LeisureEditCore, last = ref1.last, DataStore = ref1.DataStore, DataStoreEditingOptions = ref1.DataStoreEditingOptions, blockText = ref1.blockText, posFor = ref1.posFor, escapeHtml = ref1.escapeHtml, copy = ref1.copy;

  orgEditing = null;

  plainEditing = null;

  data = null;

  OrgData = (function(superClass) {
    extend(OrgData, superClass);

    function OrgData() {
      return OrgData.__super__.constructor.apply(this, arguments);
    }

    OrgData.prototype.getBlock = function(thing) {
      if (typeof thing === 'string') {
        return OrgData.__super__.getBlock.call(this, thing);
      } else {
        return thing;
      }
    };

    OrgData.prototype.load = function(first, blocks) {
      if (first) {
        linkAllSiblings(first, blocks);
      }
      return OrgData.__super__.load.call(this, first, blocks);
    };

    OrgData.prototype.parseBlocks = function(text) {
      if (text === '') {
        return [];
      } else {
        return orgDoc(parseOrgMode(text.replace(/\r\n/g, '\n')));
      }
    };

    OrgData.prototype.makeChange = function(changes) {
      OrgData.__super__.makeChange.call(this, changes);
      return linkAllSiblings(this.first, this.blocks);
    };

    OrgData.prototype.mergeChain = function(chain, id, prev, next) {
      chain.add(id, {
        prev: prev,
        next: next
      });
      chain.merge(prev, id, function(s1, s2) {
        return {
          prev: s1.prev,
          next: s2.next
        };
      });
      return chain.merge(id, next, function(s1, s2) {
        return {
          prev: s1.prev,
          next: s2.next
        };
      });
    };

    OrgData.prototype.verifyMerge = function(label, merges) {
      var id, ref2, value;
      ref2 = merges.elements;
      for (id in ref2) {
        value = ref2[id];
        if (typeof value === 'object') {
          console.log(label + ": [ " + value.prev + " -> " + value.next + " ]");
        }
      }
      return null;
    };

    OrgData.prototype.nextSibling = function(thing) {
      return this.getBlock(this.getBlock(thing).nextSibling);
    };

    OrgData.prototype.previousSibling = function(thing) {
      return this.getBlock(this.getBlock(thing).previousSibling);
    };

    OrgData.prototype.firstSibling = function(thing) {
      var id, p, ref2;
      id = getId(thing);
      while (id && (p = (ref2 = this.getBlock(id)) != null ? ref2.previousSibling : void 0)) {
        id = p;
      }
      return this.getBlock(id);
    };

    OrgData.prototype.lastSibling = function(thing) {
      var c, id;
      id = this.getBlock(thing);
      while (id && (c = this.getBlock(id).nextSibling)) {
        id = c;
      }
      return this.getBlock(id);
    };

    OrgData.prototype.parent = function(thing) {
      var ref2;
      return this.getBlock((ref2 = this.firstSibling(thing)) != null ? ref2.prev : void 0);
    };

    OrgData.prototype.firstChild = function(thing) {
      var block, n;
      if ((block = this.getBlock(thing)) && (n = this.getBlock(block.next)) && !n.previousSibling) {
        return n;
      }
    };

    OrgData.prototype.lastChild = function(thing) {
      return this.lastSibling(this.firstChild(thing));
    };

    OrgData.prototype.children = function(thing) {
      var c, child;
      c = [];
      child = this.firstChild(thing);
      while (child) {
        c.push(child);
        child = this.nextSibling(child);
      }
      return c;
    };

    return OrgData;

  })(DataStore);

  getId = function(thing) {
    if (typeof thing === 'string') {
      return thing;
    } else {
      return thing._id;
    }
  };

  MFSet = (function() {
    function MFSet() {
      this.elements = {};
    }

    MFSet.prototype.add = function(id, setObj) {
      return this.elements[id] = setObj;
    };

    MFSet.prototype.find = function(id) {
      var j, lastId, len, path, s;
      if (this.elements[id]) {
        path = [];
        while (typeof (s = this.elements[id]) === 'string') {
          path.push(s);
        }
        lastId = path.pop();
        for (j = 0, len = path.length; j < len; j++) {
          id = path[j];
          this.elements[id] = lastId;
        }
        return lastId;
      }
    };

    MFSet.prototype.merge = function(id1, id2, mergeFunc) {
      var s1, s2;
      if ((s1 = this.find(id1)) && (s2 = this.find(id2))) {
        this.elements[s2] = mergeFunc(this.elements[s1], this.elements[s2]);
        return this.elements[s1] = s2;
      }
    };

    return MFSet;

  })();

  linkAllSiblings = function(first, blocks) {
    var cur, curParent, parentStack, previousSibling, results, siblingStack;
    parentStack = ['TOP'];
    siblingStack = [[]];
    cur = blocks[first];
    results = [];
    while (cur) {
      delete cur.nextSibling;
      delete cur.previousSibling;
      curParent = blocks[last(parentStack)];
      if (cur.type === 'headline') {
        while (curParent && cur.level <= curParent.level) {
          parentStack.pop();
          siblingStack.pop();
          curParent = blocks[last(parentStack)];
        }
      }
      if (previousSibling = last(last(siblingStack))) {
        blocks[previousSibling].nextSibling = cur._id;
        blocks[cur._id].previousSibling = previousSibling;
      }
      last(siblingStack).push(cur._id);
      if (cur.type === 'headline') {
        parentStack.push(cur._id);
        siblingStack.push([]);
      }
      results.push(cur = blocks[cur.next]);
    }
    return results;
  };

  OrgEditing = (function(superClass) {
    extend(OrgEditing, superClass);

    function OrgEditing(data) {
      OrgEditing.__super__.constructor.call(this, data);
      data.on('load', (function(_this) {
        return function() {
          return _this.editor.node.html(_this.renderBlocks());
        };
      })(this));
    }

    OrgEditing.prototype.blockLineFor = function(node, offset) {
      var block, ref2;
      ref2 = this.editor.blockOffset(node, offset), block = ref2.block, offset = ref2.offset;
      return this.blockLine(block, offset);
    };

    OrgEditing.prototype.blockLine = function(block, offset) {
      var lines, text;
      text = block.text.substring(0, offset);
      lines = text.split('\n');
      return {
        line: lines.length,
        col: last(lines).length
      };
    };

    OrgEditing.prototype.lineInfo = function(block, offset) {
      var col, docLine, holder, line, p, ref2, startBlock;
      if (block) {
        ref2 = this.blockLine(block, offset), line = ref2.line, col = ref2.col;
        startBlock = block;
        docLine = line;
        while (block.prev) {
          block = this.getBlock(block.prev);
          docLine += block.text.split('\n').length - 1;
        }
        holder = this.nodeForId(startBlock._id);
        p = posFor(this.editor.domCursorForTextPosition(holder, offset));
        return {
          line: docLine,
          col: col,
          blockLine: line,
          top: Math.round(p.top),
          left: Math.round(p.left)
        };
      } else {
        return {};
      }
    };

    OrgEditing.prototype.setEditor = function(editor1) {
      this.editor = editor1;
      return this.editor.on('moved', (function(_this) {
        return function() {
          var block, blockLine, col, left, line, offset, ref2, ref3, top;
          ref2 = _this.editor.getSelectedBlockRange(), block = ref2.block, offset = ref2.offset;
          if (block) {
            ref3 = _this.lineInfo(block, offset), line = ref3.line, col = ref3.col, blockLine = ref3.blockLine, top = ref3.top, left = ref3.left;
            if (line) {
              return _this.updateStatus("line: " + (numSpan(line)) + " col: " + (numSpan(col)) + " block: " + block._id + ":" + (numSpan(blockLine)) + " top: " + (numSpan(top)) + " left: " + (numSpan(left)));
            }
          }
          return _this.updateStatus("No selection");
        };
      })(this));
    };

    OrgEditing.prototype.newChangesFor = function(first, oldBlocks, newBlocks) {
      var block, blockId, changes, j, k, len, len1, oldBlock, ref2;
      changes = OrgEditing.__super__.newChangesFor.call(this, first, oldBlocks, newBlocks);
      changes.stumps = [];
      changes.backStumps = [];
      changes.lastChildren = {};
      changes.parents = {};
      for (j = 0, len = newBlocks.length; j < len; j++) {
        block = newBlocks[j];
        this.spliceBack(block, changes);
      }
      while (block = this.getChanged(changes.stumps.pop(), changes)) {
        this.spliceBack(block, changes);
      }
      ref2 = changes.backStumps;
      for (k = 0, len1 = ref2.length; k < len1; k++) {
        blockId = ref2[k];
        oldBlock = this.getBlock(blockId);
        block = this.getChanged(blockId, changes);
        if (oldBlock.nextSibling === block.nextSibling) {
          this.spliceForward(block, changes);
        }
      }
      return changes;
    };

    OrgEditing.prototype.spliceBack = function(block, changes) {
      var isSibling, nextId, oldSibling, prev;
      if (oldSibling = this.getBlock(block._id).previousSibling) {
        changes.backStumps.unshift(oldSibling);
      }
      prev = this.getChanged(block.prev, changes);
      while (prev) {
        if ((isSibling = siblings(prev, block)) || parent(prev, block)) {
          if (block.previousSibling !== (isSibling ? prev._id : void 0)) {
            if (prev.nextSibling !== (nextId = isSibling ? block._id : void 0)) {
              if (!changes.sets[prev._id]) {
                prev = this.changeBlock(prev, changes);
              }
              if (prev.nextSibling) {
                changes.stumps.push(prev.nextSibling);
              }
              prev.nextSibling = nextId;
            }
            block.previousSibling = isSibling ? prev._id : void 0;
          }
          return;
        }
        prev = this.getChangedParent(prev, changes);
      }
    };

    OrgEditing.prototype.spliceForward = function(block, changes) {
      var curPar, next, parentStack, prev;
      parentStack = [];
      prev = next = block;
      while (next) {
        if (curPar = last(parentStack)) {
          if (parent(curPar, next)) {
            changed.lastChildren[curParent._id] = next._id;
            next = this.getChanged(next.next, changes);
          } else {
            parentStack.pop();
          }
        } else if (parent(prev, next)) {
          parentStack.push(prev);
          prev = this.getChanged(changed.lastChildren[prev._id] || next, changes);
          next = this.getChanged(prev.next, changes);
        } else if (parent(next, prev)) {
          next = null;
        } else {
          break;
        }
      }
      if (block.nextSibling !== (next != null ? next._id : void 0)) {
        this.changeBlock(block, changes).nextSibling = next != null ? next._id : void 0;
      }
      return block;
    };

    OrgEditing.prototype.getChanged = function(id, changes) {
      return id && (changes.sets[id] || this.getBlock(id));
    };

    OrgEditing.prototype.changeBlock = function(block, changes) {
      return changes.sets[block._id] || (changes.sets[block._id] = copy(block));
    };

    OrgEditing.prototype.getChangedParent = function(block, changes) {
      var first, found, id, j, len, parent, prev;
      if (parent = changes.parents[block._id]) {
        return this.getChanged(parent._id, changes);
      }
      found = [];
      first = block;
      while (block) {
        found.push(block._id);
        prev = block;
        block = this.getChanged(block.previousSibling, changes);
      }
      for (j = 0, len = found.length; j < len; j++) {
        id = found[j];
        changes.parents[id] = prev._id;
      }
      changes.lastChildren[prev._id] = first._id;
      return prev;
    };

    return OrgEditing;

  })(DataStoreEditingOptions);

  parent = function(prev, next) {
    return prev.type === 'headline' && (next.type !== 'headline' || prev.level < next.level);
  };

  siblings = function(prev, next) {
    var ref2;
    return (prev.type !== 'headline' && next.type !== 'headline') || ((prev.type === (ref2 = next.type) && ref2 === 'headline') && prev.level === next.level);
  };

  PlainEditing = (function(superClass) {
    extend(PlainEditing, superClass);

    function PlainEditing() {
      return PlainEditing.__super__.constructor.apply(this, arguments);
    }

    PlainEditing.prototype.nodeForId = function(id) {
      return $("#plain-" + id);
    };

    PlainEditing.prototype.idForNode = function(node) {
      var ref2;
      return (ref2 = node.id.match(/^plain-(.*)$/)) != null ? ref2[1] : void 0;
    };

    PlainEditing.prototype.parseBlocks = function(text) {
      return this.data.parseBlocks(text);
    };

    PlainEditing.prototype.renderBlock = function(block) {
      return ["<span id='plain-" + block._id + "' data-block>" + (escapeHtml(block.text)) + "</span>", block.next];
    };

    PlainEditing.prototype.updateStatus = function(line) {
      return $("#plainStatus").html(line);
    };

    return PlainEditing;

  })(OrgEditing);

  FancyEditing = (function(superClass) {
    extend(FancyEditing, superClass);

    function FancyEditing() {
      return FancyEditing.__super__.constructor.apply(this, arguments);
    }

    FancyEditing.prototype.changed = function(changes) {
      return this.editor.node.html(this.renderBlocks());
    };

    FancyEditing.prototype.nodeForId = function(id) {
      return $("#fancy-" + id);
    };

    FancyEditing.prototype.idForNode = function(node) {
      var ref2;
      return (ref2 = node.id.match(/^fancy-(.*)$/)) != null ? ref2[1] : void 0;
    };

    FancyEditing.prototype.parseBlocks = function(text) {
      return this.data.parseBlocks(text);
    };

    FancyEditing.prototype.renderBlock = function(block) {
      var child, html, ref2;
      html = block.type === 'headline' ? "<div " + (blockAttrs(block)) + " contenteditable='false'>" + (blockLabel(block)) + "<div contenteditable='true'>" + (contentSpan(block.text, 'text')) + (((function() {
        var j, len, ref2, ref3, results;
        ref3 = (ref2 = this.data.children(block)) != null ? ref2 : [];
        results = [];
        for (j = 0, len = ref3.length; j < len; j++) {
          child = ref3[j];
          results.push(this.renderBlock(child)[0]);
        }
        return results;
      }).call(this)).join('')) + "</div></div>" : block.type === 'code' ? "<span " + (blockAttrs(block)) + ">" + (blockLabel(block)) + (escapeHtml(block.text)) + "</span>" : "<span " + (blockAttrs(block)) + ">" + (blockLabel(block)) + (escapeHtml(block.text)) + "</span>";
      return [html, ((ref2 = this.data.nextSibling(block)) != null ? ref2._id : void 0) || !this.data.firstChild(block) && block.next];
    };

    FancyEditing.prototype.updateStatus = function(line) {
      return $("#orgStatus").html(line);
    };

    return FancyEditing;

  })(OrgEditing);

  numSpan = function(n) {
    return "<span class='status-num'>" + n + "</span>";
  };

  blockLabel = function(block) {
    return "<span class='blockLabel' contenteditable='false' data-noncontent>[" + block.type + " " + block._id + "]</span>";
  };

  blockAttrs = function(block) {
    var extra;
    extra = '';
    if (block.type === 'headline') {
      extra += " data-headline='" + (escapeAttr(block.level)) + "'";
    }
    return "id='fancy-" + (escapeAttr(block._id)) + "' data-block='" + (escapeAttr(block._id)) + "' data-type='" + (escapeAttr(block.type)) + "'" + extra;
  };

  contentSpan = function(str, type) {
    str = escapeHtml(str);
    if (str) {
      return "<span" + (type ? " data-org-type='" + (escapeAttr(type)) + "'" : '') + ">" + str + "</span>";
    } else {
      return '';
    }
  };

  escapeAttr = function(str) {
    if (typeof str === 'string') {
      return str.replace(/['"&]/g, function(c) {
        switch (c) {
          case '"':
            return '&quot;';
          case "'":
            return '&#39;';
          case '&':
            return '&amp;';
        }
      });
    } else {
      return str;
    }
  };

  displayStructure = function(data) {
    var bad, check, checks, cur, i, info, level, p, parentStack, prev, prevParent;
    parentStack = [];
    info = "";
    level = 0;
    cur = data.getBlock(data.first);
    prevParent = null;
    checks = {
      nextSibling: {},
      previousSibling: {},
      prev: {}
    };
    check = cur;
    prev = null;
    while (check) {
      checks.nextSibling[check.previousSibling] = check._id;
      checks.previousSibling[check.nextSibling] = check._id;
      checks.prev[check.next] = check._id;
      prev = check;
      check = data.getBlock(check.next);
    }
    while (cur) {
      bad = [];
      if (cur.nextSibling !== checks.nextSibling[cur._id]) {
        bad.push('nextSibling');
      }
      if (cur.previousSibling !== checks.previousSibling[cur._id]) {
        bad.push('previousSibling');
      }
      if (cur.prev !== checks.prev[cur._id]) {
        bad.push('prev');
      }
      if (!cur.previousSibling) {
        p = cur;
        while (p = data.parent(p)) {
          level++;
        }
      }
      info += "" + (((function() {
        var j, ref2, results;
        results = [];
        for (i = j = 0, ref2 = level; 0 <= ref2 ? j < ref2 : j > ref2; i = 0 <= ref2 ? ++j : --j) {
          results.push('   ');
        }
        return results;
      })()).join('')) + cur._id + (checkStructure(cur, bad)) + ": " + (JSON.stringify(cur.text)) + "\n";
      if (!cur.nextSibling) {
        level = 0;
      }
      cur = data.getBlock(cur.next);
    }
    return $("#blocks").html(info);
  };

  checkStructure = function(block, bad) {
    var err;
    if (bad.length) {
      return ' <span class="err">[' + ((function() {
        var j, len, results;
        results = [];
        for (j = 0, len = bad.length; j < len; j++) {
          err = bad[j];
          results.push(err + ": " + block[err]);
        }
        return results;
      })()).join(', ') + ']</span>';
    } else {
      return '';
    }
  };

  $(document).ready(function() {
    var editor;
    window.DATA = data = new OrgData();
    data.on('change', function(changes) {
      return displayStructure(data);
    }).on('load', function() {
      return displayStructure(data);
    });
    window.ED = editor = new LeisureEditCore($("#fancyEditor"), new FancyEditing(data));
    window.ED2 = new LeisureEditCore($("#plainEditor"), new PlainEditing(data));
    return setTimeout((function() {
      return editor.loadURL("example.lorg");
    }), 1);
  });

}).call(this);

//# sourceMappingURL=example.js.map
